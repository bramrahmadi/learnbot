name: Security Scanning

on:
  push:
    branches: [main, "feature/**"]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly security scans on Monday at 08:00 UTC
    - cron: "0 8 * * 1"

env:
  GO_VERSION: "stable"

jobs:
  # ─── Go Dependency Vulnerability Scan ────────────────────────────────────────
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, resume-parser, job-aggregator, learning-resources, database]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck on ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: govulncheck ./...

  # ─── Container Image Scanning ────────────────────────────────────────────────
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        service:
          # api-gateway uses repo root as context because go.mod has a
          # replace directive pointing to ../resume-parser
          - name: api-gateway
            context: .
            dockerfile: api-gateway/Dockerfile
          - name: resume-parser
            context: ./resume-parser
            dockerfile: resume-parser/Dockerfile
          - name: job-aggregator
            context: ./job-aggregator
            dockerfile: job-aggregator/Dockerfile
          # learning-resources uses repo root as context because go.mod has a
          # replace directive pointing to ../database
          - name: learning-resources
            context: .
            dockerfile: learning-resources/Dockerfile
          - name: frontend
            context: ./frontend
            dockerfile: frontend/Dockerfile

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          docker build \
            -t learnbot/${{ matrix.service.name }}:scan \
            -f ${{ matrix.service.dockerfile }} \
            ${{ matrix.service.context }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: learnbot/${{ matrix.service.name }}:scan
          format: sarif
          output: trivy-${{ matrix.service.name }}.sarif
          severity: CRITICAL,HIGH
          # exit-code: "0" — Trivy reports to Security tab but does not block CI.
          # Go binary vulnerabilities are already caught by govulncheck (which
          # does block CI). Trivy handles OS/container-level scanning.
          exit-code: "0"
          ignore-unfixed: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: trivy-${{ matrix.service.name }}.sarif
          category: trivy-${{ matrix.service.name }}

  # ─── Static Code Analysis ────────────────────────────────────────────────────
  gosec:
    name: Go Security Analysis (gosec)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec on api-gateway
        working-directory: api-gateway
        run: go mod download && gosec -fmt sarif -out ../gosec-api-gateway.sarif ./... || true

      - name: Run gosec on resume-parser
        working-directory: resume-parser
        run: go mod download && gosec -fmt sarif -out ../gosec-resume-parser.sarif ./... || true

      - name: Run gosec on job-aggregator
        working-directory: job-aggregator
        run: go mod download && gosec -fmt sarif -out ../gosec-job-aggregator.sarif ./... || true

      - name: Run gosec on learning-resources
        working-directory: learning-resources
        run: go mod download && gosec -fmt sarif -out ../gosec-learning-resources.sarif ./... || true

      - name: Upload gosec results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: gosec-api-gateway.sarif
          category: gosec-api-gateway

  # ─── Secret Scanning ─────────────────────────────────────────────────────────
  gitleaks:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ─── Dependency License Check ────────────────────────────────────────────────
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check frontend licenses
        working-directory: frontend
        run: |
          npm install
          # Check for licenses that are NOT acceptable (GPL-2.0, GPL-3.0, AGPL, SSPL, etc.)
          # We use --excludeLicenses to block only copyleft licenses that require
          # open-sourcing the entire application. LGPL, MPL, and similar file-level
          # copyleft licenses are acceptable for use in commercial applications.
          npx license-checker \
            --excludePrivatePackages \
            --onlyAllow "MIT;MIT AND ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;CC-BY-3.0;CC-BY-4.0;Unlicense;0BSD;LGPL-2.0;LGPL-2.0-only;LGPL-2.0-or-later;LGPL-2.1;LGPL-2.1-only;LGPL-2.1-or-later;LGPL-3.0;LGPL-3.0-only;LGPL-3.0-or-later;MPL-2.0;Python-2.0;BlueOak-1.0.0;W3C;Artistic-2.0" \
            --summary

  # ─── Infrastructure Security Scan ────────────────────────────────────────────
  tfsec:
    name: Terraform Security Scan (tfsec)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec and generate SARIF
        run: |
          tfsec infrastructure/terraform \
            --format sarif \
            --out tfsec.sarif \
            --soft-fail \
            --no-color || true
          # Ensure file exists even if tfsec finds no issues
          if [ ! -f tfsec.sarif ]; then
            echo '{"version":"2.1.0","runs":[]}' > tfsec.sarif
          fi

      - name: Upload tfsec results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: tfsec.sarif
          category: tfsec

  # ─── OWASP Dependency Check ──────────────────────────────────────────────────
  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run npm audit
        working-directory: frontend
        run: |
          npm install
          npm audit --audit-level=high --json > npm-audit.json || true
          cat npm-audit.json

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-results
          path: frontend/npm-audit.json

  # ─── Security Summary ────────────────────────────────────────────────────────
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs:
      - govulncheck
      - gosec
      - gitleaks
      - license-check
      - tfsec
      - npm-audit
    if: always()

    steps:
      - name: Security scan summary
        run: |
          echo "## Security Scan Results"
          echo "govulncheck: ${{ needs.govulncheck.result }}"
          echo "gosec: ${{ needs.gosec.result }}"
          echo "gitleaks: ${{ needs.gitleaks.result }}"
          echo "license-check: ${{ needs.license-check.result }}"
          echo "tfsec: ${{ needs.tfsec.result }}"
          echo "npm-audit: ${{ needs.npm-audit.result }}"
